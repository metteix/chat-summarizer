from typing import List, Any, Literal
from langchain_openai import ChatOpenAI
from pydantic import BaseModel, Field


# --- –ú–æ–¥–µ–ª–∏ –æ—Ç–≤–µ—Ç–∞ ---
class ItemAnalysis(BaseModel):
    id: int = Field(description="ID –æ–±—ä–µ–∫—Ç–∞ –∏–∑ –±–∞–∑—ã")
    is_important: bool = Field(description="True, –µ—Å–ª–∏ —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —É—á–µ–±—ã/—Ä–∞–±–æ—Ç—ã. False, –µ—Å–ª–∏ —Å–ø–∞–º/–æ—Ñ—Ñ—Ç–æ–ø.")
    about: str = Field(
        description="–ö—Ä–∞—Ç–∫–∞—è –≤—ã–∂–∏–º–∫–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –î–ª—è —Å—Å—ã–ª–æ–∫ - –∑–∞–≥–æ–ª–æ–≤–æ–∫, –¥–ª—è –∑–∞–¥–∞—á - –¥–µ–π—Å—Ç–≤–∏–µ + –¥–µ–¥–ª–∞–π–Ω(–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω), –¥–ª—è —Ö–µ—à—Ç–µ–≥–æ–≤ - –≤–∞–∂–Ω—ã–µ —Ö–µ—à—Ç–µ–≥–∏, –¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏–π - –≤–∞–∂–Ω—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è, –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ - –∑–∞–≥–æ–ª–æ–≤–∫–∏.")


class BatchAnalysis(BaseModel):
    items: List[ItemAnalysis]


# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ---
llm = ChatOpenAI(model="gpt-4o-mini", temperature=0)
structured_llm = llm.with_structured_output(BatchAnalysis)

# --- –£–ù–ò–ö–ê–õ–¨–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò (–ü–†–û–ú–ü–¢–´) ---
PROMPTS = {
    "link": """
    –¢—ã –ø–æ–º–æ—â–Ω–∏–∫ —Å—Ç—É–¥–µ–Ω—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –°–°–´–õ–û–ö –∏–∑ —á–∞—Ç–∞.

    –ö—Ä–∏—Ç–µ—Ä–∏–∏ –í–ê–ñ–ù–û–°–¢–ò (is_important = True):
    1. –°—Å—ã–ª–∫–∏ –Ω–∞ —É—á–µ–±–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã (GitHub, StackOverflow, Moodle, –í–∏–∫–∏–ø–µ–¥–∏—è, Google Docs).
    2. –°—Å—ã–ª–∫–∏ –Ω–∞ YouTube, –µ—Å–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ —ç—Ç–æ –ª–µ–∫—Ü–∏—è –∏–ª–∏ —Ç—É—Ç–æ—Ä–∏–∞–ª.
    3. –õ—é–±—ã–µ —Å—Å—ã–ª–∫–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç "–ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ", "–≤–∞–∂–Ω–æ", "–¥–ª—è —ç–∫–∑–∞–º–µ–Ω–∞".

    –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ú–£–°–û–†–ê (is_important = False):
    1. TikTok, Instagram, —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (–µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —É—á–µ–±–Ω—ã–π –ø—Ä–∏–º–µ—Ä).
    2. –°—Å—ã–ª–∫–∏ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –ø–æ—Ö–æ–∂–∏–µ –Ω–∞ —Å–ø–∞–º –∏–ª–∏ —Ä–µ–∫–ª–∞–º—É.

    –ü–æ–ª–µ 'about': –ù–∞–ø–∏—à–∏ –ó–ê–ì–û–õ–û–í–û–ö —Ä–µ—Å—É—Ä—Å–∞, –∏—Å—Ö–æ–¥—è –∏–∑ URL –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    üî¥ –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: –ú–∞–∫—Å–∏–º—É–º 10 —Å–ª–æ–≤ (–¥–æ 70 —Å–∏–º–≤–æ–ª–æ–≤).
    –ü—Ä–∏–º–µ—Ä: "–õ–µ–∫—Ü–∏—è –ø–æ –ê–ª–≥–æ—Å–∞–º (YouTube)"
    """,

    "doc": """
    –¢—ã –ø–æ–º–æ—â–Ω–∏–∫ —Å—Ç—É–¥–µ–Ω—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –î–û–ö–£–ú–ï–ù–¢–´ (—Ñ–∞–π–ª—ã).

    –ö—Ä–∏—Ç–µ—Ä–∏–∏ –í–ê–ñ–ù–û–°–¢–ò:
    1. –§–æ—Ä–º–∞—Ç—ã .pdf, .docx, .pptx, .xlsx, .py, .zip (–æ–±—ã—á–Ω–æ —ç—Ç–æ —É—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã).
    2. –ï—Å–ª–∏ –∏–º—è —Ñ–∞–π–ª–∞ –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–µ (lab1.pdf, lecture.pptx).
    3. –ö–∞—Ä—Ç–∏–Ω–∫–∏ (.jpg, .png) –≤–∞–∂–Ω—ã –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –≥–æ–≤–æ—Ä–∏—Ç "–≤–æ—Ç —Å–∫—Ä–∏–Ω –∑–∞–¥–∞–Ω–∏—è" –∏–ª–∏ "—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ".

    –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ú–£–°–û–†–ê:
    1. –°—Ç–∏–∫–µ—Ä—ã, –º–µ–º—ã (–æ–±—ã—á–Ω–æ —Å—Ç—Ä–∞–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç "–ª–æ–ª").

    –ü–æ–ª–µ 'about': –û–±—ä–µ–¥–∏–Ω–∏ –∏–º—è —Ñ–∞–π–ª–∞ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç.
    üî¥ –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: –ú–∞–∫—Å–∏–º—É–º 10 —Å–ª–æ–≤.
    –ü—Ä–∏–º–µ—Ä: "–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –∫ –ª–µ–∫—Ü–∏–∏ 5"
    """,

    "task": """
    –¢—ã –ø–æ–º–æ—â–Ω–∏–∫ —Å—Ç—É–¥–µ–Ω—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–π—Ç–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –ó–ê–î–ê–ß–ò –∏ –î–ï–î–õ–ê–ô–ù–´.

    –ö—Ä–∏—Ç–µ—Ä–∏–∏ –í–ê–ñ–ù–û–°–¢–ò:
    1. –°–æ–æ–±—â–µ–Ω–∏—è, –≥–¥–µ –∫–æ–≥–æ-—Ç–æ –ø—Ä–æ—Å—è—Ç —á—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞—Ç—å.
    2. –£–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å—Ä–æ–∫–æ–≤ (–∑–∞–≤—Ç—Ä–∞, –¥–æ —Å—Ä–µ–¥—ã, –≤ 12:00).
    3. –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω–∞—è –∏–Ω—Ñ–∞ (—Å–±–æ—Ä –¥–µ–Ω–µ–≥, –ø–µ—Ä–µ–Ω–æ—Å –ø–∞—Ä—ã).

    –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ú–£–°–û–†–ê:
    1. –†–∏—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã ("–∫–æ–≥–¥–∞ –∂–µ —è —Å–¥–æ—Ö–Ω—É?").
    2. –û–±—Å—É–∂–¥–µ–Ω–∏–µ –ª–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º ("–Ω–∞–¥–æ –±—ã –ø–æ—Å–ø–∞—Ç—å").

    –ü–æ–ª–µ 'about': –ß–µ—Ç–∫–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∑–∞–¥–∞—á—É. –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞—Ç–∞/–≤—Ä–µ–º—è ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏.
    üî¥ –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: –ú–∞–∫—Å–∏–º—É–º 12 —Å–ª–æ–≤.
    –ü—Ä–∏–º–µ—Ä: "–°–¥–∞—Ç—å –ª–∞–±—É –¥–æ –≤—Ç–æ—Ä–Ω–∏–∫–∞ (12:00)"
    """,

    "hashtag": """
    –¢—ã –ø–æ–º–æ—â–Ω–∏–∫ —Å—Ç—É–¥–µ–Ω—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –•–≠–®–¢–ï–ì–ò.
    
    –í–ê–ñ–ù–û: –•—ç—à—Ç–µ–≥ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –æ—Ü–µ–Ω–∏–≤–∞–π —Å–∞–º —Å–º—ã—Å–ª —Å–ª–æ–≤–∞ –≤ —Ö—ç—à—Ç–µ–≥–µ.

    –ö—Ä–∏—Ç–µ—Ä–∏–∏ –í–ê–ñ–ù–û–°–¢–ò (is_important = True):
    1. –¢–µ–≥–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (#–º–∞—Ç–∞–Ω, #—Ñ–∏–∑–∏–∫–∞, #–∏—Å—Ç–æ—Ä–∏—è) ‚Äî –í–ê–ñ–ù–´ –í–°–ï–ì–î–ê, –¥–∞–∂–µ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ç–µ–º–µ).
    2. –¢–µ–≥–∏ —Ç–∏–ø–æ–≤ –∑–∞–¥–∞–Ω–∏–π (#–¥–∑, #–ª–∞–±–∞, #–¥–µ–¥–ª–∞–π–Ω, #—ç–∫–∑–∞–º–µ–Ω, #—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ).
    3. –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ–≥–∏ (#—Å–±–æ—Ä, #–æ–±—ä—è–≤–ª–µ–Ω–∏–µ, #–≤–∞–∂–Ω–æ).

    –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ú–£–°–û–†–ê (is_important = False):
    1. –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏ (#–±–æ–ª—å, #–∂–∏–∑–∞, #–ª–æ–ª, #–∫–µ–∫).
    2. –ë–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ —Ç–µ–≥–∏, —Å–ø–∞–º –∏–ª–∏ –ª–∏—á–Ω—ã–µ –º–µ—Ç–∫–∏, –Ω–µ –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ —É—á–µ–±–µ.
    3. –¢–µ–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–∞–≤—è—Ç –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫ (#–ø—Ä–∏–≤–µ—Ç, #—á–∞—Ç).

    –ü–æ–ª–µ 'about':
    - –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç (—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è), –æ–ø–∏—à–∏ —Å—É—Ç—å –æ–±—Å—É–∂–¥–µ–Ω–∏—è.
    - –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ù–ï–¢ (–∏–ª–∏ –æ–Ω –¥—É–±–ª–∏—Ä—É–µ—Ç —Ç–µ–≥), –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é. 
    üî¥ –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: –ú–∞–∫—Å–∏–º—É–º 10 —Å–ª–æ–≤.
    –ü—Ä–∏–º–µ—Ä: "–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é"
    """,

    "mention": """
    –¢—ã –ø–æ–º–æ—â–Ω–∏–∫ —Å—Ç—É–¥–µ–Ω—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –£–ü–û–ú–ò–ù–ê–ù–ò–Ø –õ–Æ–î–ï–ô (–º–µ–Ω—à–Ω—ã).

    –ö—Ä–∏—Ç–µ—Ä–∏–∏ –í–ê–ñ–ù–û–°–¢–ò:
    1. –ö–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫–∞ –∑–æ–≤—É—Ç, —á—Ç–æ–±—ã –¥–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –∏–ª–∏ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ —É—á–µ–±–µ.
    2. –£–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å—Ç–∞—Ä–æ—Å—Ç—ã –∏–ª–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –ø–æ –¥–µ–ª—É.
    3. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö ("@user —Ç—ã –¥–µ–ª–∞–µ—à—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é").

    –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ú–£–°–û–†–ê:
    1. "–ì–æ–ª—ã–µ" —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ (–ø—Ä–æ—Å—Ç–æ "@user") ‚Äî —Å—á–∏—Ç–∞–µ–º –º—É—Å–æ—Ä–æ–º, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –ø–µ—Ä–µ–∫–ª–∏—á–∫–∞.
    2. –£–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —à—É—Ç–∫–∞—Ö –∏–ª–∏ —Ñ–ª—É–¥–µ.
    3. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è ("@user –ø—Ä–∏–≤–µ—Ç").

    –ü–æ–ª–µ 'about': 
    - –ù–∞–ø–∏—à–∏, –∫–æ–≥–æ –∏ –∑–∞—á–µ–º –ø–æ–∑–≤–∞–ª–∏. 
    - –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–∞–ª–æ, –ø–æ–ø—Ä–æ–±—É–π —É–≥–∞–¥–∞—Ç—å —Ü–µ–ª—å –ø–æ —Ç–æ–Ω—É, –∏–ª–∏ –Ω–∞–ø–∏—à–∏ "–í—ã–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è".
    üî¥ –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: –ú–∞–∫—Å–∏–º—É–º 10 —Å–ª–æ–≤.
    –ü—Ä–∏–º–µ—Ä: "–í–æ–ø—Ä–æ—Å –∫ @ivanov –ø–æ —ç–∫–∑–∞–º–µ–Ω—É"
    """
}


async def analyze_items(
        items: List[Any],
        item_type: Literal["link", "doc", "task", "mention", "hashtag"]
) -> List[dict]:
    if not items:
        return []

    # 1. –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    input_lines = []
    for item in items:
        # –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª–µ–π (—Ç–∞–∫ –∫–∞–∫ —É Link –ø–æ–ª–µ url, —É Doc –ø–æ–ª–µ document_name)
        main_content = ""
        if item_type == "link":
            main_content = item.url
        elif item_type == "doc":
            main_content = item.document_name
        elif item_type == "task":
            main_content = item.task_name
        elif item_type == "mention":
            main_content = item.mention
        elif item_type == "hashtag":
            main_content = item.hashtag

        input_lines.append(f"ID: {item.id} | Content: {main_content} | User Context: {item.context}")

    text_block = "\n".join(input_lines)

    # 2. –í—ã–±–∏—Ä–∞–µ–º –ü–†–ê–í–ò–õ–¨–ù–´–ô –ø—Ä–æ–º–ø—Ç
    system_prompt = PROMPTS.get(item_type, "Filter specific important items.")

    full_prompt = f"{system_prompt}\n\nList to analyze:\n{text_block}"

    try:
        # 3. –ó–∞–ø—Ä–æ—Å
        result = await structured_llm.ainvoke(full_prompt)

        # 4. –ú—ç–ø–ø–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        verdict_map = {v.id: v for v in result.items}
        filtered = []

        for item in items:
            verdict = verdict_map.get(item.id)
            if verdict and verdict.is_important:
                filtered.append({
                    "original": item,
                    "about": verdict.about
                })
        return filtered

    except Exception as e:
        print(f"ML Error: {e}")
        return []
